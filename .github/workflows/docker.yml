name: Build & Push Docker Image

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'package.json'
      - 'package-lock.json'
      - 'Dockerfile'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Update active cloud instances
        if: success()
        env:
          CLOUD_API_URL: ${{ secrets.CLOUD_API_URL }}
          CLOUD_ADMIN_TOKEN: ${{ secrets.CLOUD_ADMIN_TOKEN }}
        run: |
          if [ -z "$CLOUD_API_URL" ] || [ -z "$CLOUD_ADMIN_TOKEN" ]; then
            echo "CLOUD_API_URL or CLOUD_ADMIN_TOKEN not set, skipping instance update"
            exit 0
          fi
          echo "Updating active cloud instances..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "$CLOUD_API_URL/api/cloud/ops/update-machines" \
            -H "Authorization: Bearer $CLOUD_ADMIN_TOKEN" \
            -H "Content-Type: application/json")
          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | head -n -1)
          echo "HTTP $http_code: $body"
          if [ "$http_code" -ge 400 ]; then
            echo "::warning::Failed to update cloud instances (HTTP $http_code)"
          fi
