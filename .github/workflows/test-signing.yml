name: Test Windows Code Signing

on:
  workflow_dispatch:

jobs:
  test-sign:
    runs-on: windows-latest
    timeout-minutes: 15
    steps:
      - name: Create dummy exe
        shell: pwsh
        run: |
          $bytes = [System.IO.File]::ReadAllBytes("C:\Windows\System32\cmd.exe")
          [System.IO.File]::WriteAllBytes("$PWD\test.exe", $bytes)
          echo "Created test.exe ($($(Get-Item test.exe).Length) bytes)"

      - name: Sign with SSL.com eSigner
        uses: sslcom/esigner-codesign@develop
        with:
          command: sign
          username: ${{ secrets.ES_USERNAME }}
          password: ${{ secrets.ES_PASSWORD }}
          credential_id: ${{ secrets.ES_CREDENTIAL_ID }}
          totp_secret: ${{ secrets.ES_TOTP_SECRET }}
          file_path: ${{ github.workspace }}\test.exe
          environment_name: PROD
          override: true

      - name: Verify signature
        shell: pwsh
        run: |
          $sig = Get-AuthenticodeSignature -FilePath "test.exe"
          echo "Status: $($sig.Status)"
          echo "Signer: $($sig.SignerCertificate.Subject)"
          echo "Issuer: $($sig.SignerCertificate.Issuer)"
          if ($sig.Status -ne "Valid") { exit 1 }
