#!/bin/bash

# Create symlink so 'quoroom' is on PATH.
BIN_PATH="/usr/local/lib/quoroom/bin/quoroom"
ln -sf "${BIN_PATH}" /usr/local/bin/quoroom

PORT="${QUOROOM_PORT:-3700}"
URL="http://localhost:${PORT}"

# Installers run as root; detect the active desktop user.
CONSOLE_USER="$(stat -f%Su /dev/console 2>/dev/null || true)"
if [ -z "${CONSOLE_USER}" ] || [ "${CONSOLE_USER}" = "root" ]; then
  exit 0
fi
CONSOLE_UID="$(id -u "${CONSOLE_USER}" 2>/dev/null || true)"
if [ -z "${CONSOLE_UID}" ]; then
  exit 0
fi

LOG_DIR="/Users/${CONSOLE_USER}/Library/Logs/Quoroom"
LOG_FILE="${LOG_DIR}/server.log"
mkdir -p "${LOG_DIR}"
chown "${CONSOLE_USER}" "${LOG_DIR}" 2>/dev/null || true

# Kill any old quoroom server â€” the binaries were just overwritten so the old
# process is running stale code and would die soon anyway.
OLD_PIDS="$(lsof -nP -iTCP:"${PORT}" -sTCP:LISTEN -t 2>/dev/null || true)"
if [ -n "${OLD_PIDS}" ]; then
  kill ${OLD_PIDS} 2>/dev/null || true
  sleep 1
  kill -9 ${OLD_PIDS} 2>/dev/null || true
fi

# Start fresh server.
START_CMD="nohup \"${BIN_PATH}\" serve --port ${PORT} >> \"${LOG_FILE}\" 2>&1 &"
launchctl asuser "${CONSOLE_UID}" sudo -u "${CONSOLE_USER}" /bin/bash -lc "${START_CMD}" 2>/dev/null \
  || sudo -u "${CONSOLE_USER}" /bin/bash -lc "${START_CMD}" 2>/dev/null \
  || true

# Open dashboard in the logged-in user's browser.
launchctl asuser "${CONSOLE_UID}" sudo -u "${CONSOLE_USER}" open "${URL}" 2>/dev/null \
  || sudo -u "${CONSOLE_USER}" open "${URL}" 2>/dev/null \
  || true

exit 0
