#!/bin/bash

# Create symlink so 'quoroom' is on PATH.
BIN_PATH="/usr/local/lib/quoroom/bin/quoroom"
if [ ! -x "${BIN_PATH}" ] && [ -x "${HOME}/usr/local/lib/quoroom/bin/quoroom" ]; then
  BIN_PATH="${HOME}/usr/local/lib/quoroom/bin/quoroom"
fi
ln -sf "${BIN_PATH}" /usr/local/bin/quoroom 2>/dev/null || true

PORT="${QUOROOM_PORT:-3700}"
URL="http://localhost:${PORT}"

CONSOLE_USER="$(stat -f%Su /dev/console 2>/dev/null || true)"
if [ -z "${CONSOLE_USER}" ] || [ "${CONSOLE_USER}" = "root" ]; then
  CONSOLE_USER="${SUDO_USER:-${USER:-}}"
fi
CONSOLE_UID="$(id -u "${CONSOLE_USER}" 2>/dev/null || true)"

install_launcher_app() {
  APPS_DIR="$1"
  LAUNCHER_SRC="/usr/local/lib/quoroom/launcher/Quoroom Server.app"

  # Remove legacy launcher names to avoid duplicate Dock entries after upgrade.
  rm -rf "/Applications/Quoroom.app" "/Applications/Quoroom Server.app"
  if [ -n "${CONSOLE_USER}" ] && [ "${CONSOLE_USER}" != "root" ]; then
    rm -rf "/Users/${CONSOLE_USER}/Applications/Quoroom.app" "/Users/${CONSOLE_USER}/Applications/Quoroom Server.app"
  fi

  # Copy pre-built, signed .app bundle (ditto preserves code signatures).
  if [ -d "${LAUNCHER_SRC}" ]; then
    ditto "${LAUNCHER_SRC}" "${APPS_DIR}/Quoroom Server.app"
  else
    echo "Warning: pre-built launcher not found at ${LAUNCHER_SRC}" >&2
  fi
}

LAUNCHER_APPS_DIR="/Applications"
if [ ! -w "${LAUNCHER_APPS_DIR}" ]; then
  if [ -n "${CONSOLE_USER}" ] && [ "${CONSOLE_USER}" != "root" ]; then
    LAUNCHER_APPS_DIR="/Users/${CONSOLE_USER}/Applications"
  else
    LAUNCHER_APPS_DIR="${HOME}/Applications"
  fi
fi
mkdir -p "${LAUNCHER_APPS_DIR}" 2>/dev/null || true
install_launcher_app "${LAUNCHER_APPS_DIR}"
if [ -n "${CONSOLE_USER}" ] && [ "${CONSOLE_USER}" != "root" ]; then
  chown -R "${CONSOLE_USER}" "${LAUNCHER_APPS_DIR}/Quoroom Server.app" 2>/dev/null || true
fi

# Installers run as root; detect the active desktop user.
if [ -z "${CONSOLE_USER}" ] || [ "${CONSOLE_USER}" = "root" ]; then
  exit 0
fi
if [ -z "${CONSOLE_UID}" ]; then
  exit 0
fi

LOG_DIR="/Users/${CONSOLE_USER}/Library/Logs/Quoroom"
LOG_FILE="${LOG_DIR}/server.log"
mkdir -p "${LOG_DIR}"
chown "${CONSOLE_USER}" "${LOG_DIR}" 2>/dev/null || true

# Clean stale auto-update directory — full installer supersedes user-space updates.
# The server also does this check on startup, but cleaning here ensures the
# wrapper script uses the fresh bundled code immediately.
USER_APP_DIR="/Users/${CONSOLE_USER}/.quoroom/app"
if [ -d "${USER_APP_DIR}" ]; then
  rm -rf "${USER_APP_DIR}"
fi

# Kill any old quoroom server — the binaries were just overwritten so the old
# process is running stale code and would die soon anyway.
OLD_PIDS="$(lsof -nP -iTCP:"${PORT}" -sTCP:LISTEN -t 2>/dev/null || true)"
if [ -n "${OLD_PIDS}" ]; then
  kill ${OLD_PIDS} 2>/dev/null || true
  sleep 1
  kill -9 ${OLD_PIDS} 2>/dev/null || true
fi

# Launch the tray app — it handles server start, health check, and browser open.
APP_TO_LAUNCH="${LAUNCHER_APPS_DIR}/Quoroom Server.app"
launchctl asuser "${CONSOLE_UID}" sudo -u "${CONSOLE_USER}" open "${APP_TO_LAUNCH}" 2>/dev/null \
  || sudo -u "${CONSOLE_USER}" open "${APP_TO_LAUNCH}" 2>/dev/null \
  || true

exit 0
