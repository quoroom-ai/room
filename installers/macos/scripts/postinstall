#!/bin/bash

# Create symlink so 'quoroom' is on PATH.
BIN_PATH="/usr/local/lib/quoroom/bin/quoroom"
if [ ! -x "${BIN_PATH}" ] && [ -x "${HOME}/usr/local/lib/quoroom/bin/quoroom" ]; then
  BIN_PATH="${HOME}/usr/local/lib/quoroom/bin/quoroom"
fi
ln -sf "${BIN_PATH}" /usr/local/bin/quoroom 2>/dev/null || true

PORT="${QUOROOM_PORT:-3700}"
URL="http://localhost:${PORT}"

CONSOLE_USER="$(stat -f%Su /dev/console 2>/dev/null || true)"
if [ -z "${CONSOLE_USER}" ] || [ "${CONSOLE_USER}" = "root" ]; then
  CONSOLE_USER="${SUDO_USER:-${USER:-}}"
fi
CONSOLE_UID="$(id -u "${CONSOLE_USER}" 2>/dev/null || true)"

create_launcher_app() {
  APPS_DIR="$1"
  # Remove legacy launcher name to avoid duplicate Dock entries after upgrade.
  rm -rf "/Applications/Quoroom.app" "/Applications/Quoroom Server.app"
  if [ -n "${CONSOLE_USER}" ] && [ "${CONSOLE_USER}" != "root" ]; then
    rm -rf "/Users/${CONSOLE_USER}/Applications/Quoroom.app" "/Users/${CONSOLE_USER}/Applications/Quoroom Server.app"
  fi

  APP_PATH="${APPS_DIR}/Quoroom Server.app"
  APP_CONTENTS="${APP_PATH}/Contents"
  APP_MACOS="${APP_CONTENTS}/MacOS"
  APP_RESOURCES="${APP_CONTENTS}/Resources"
  APP_EXEC="${APP_MACOS}/QuoroomServerLauncher"
  ICON_SRC_SERVER="/usr/local/lib/quoroom/ui/quoroom-server.icns"
  ICON_SRC_DEFAULT="/usr/local/lib/quoroom/ui/quoroom.icns"
  if [ ! -f "${ICON_SRC_SERVER}" ] && [ -f "${HOME}/usr/local/lib/quoroom/ui/quoroom-server.icns" ]; then
    ICON_SRC_SERVER="${HOME}/usr/local/lib/quoroom/ui/quoroom-server.icns"
    ICON_SRC_DEFAULT="${HOME}/usr/local/lib/quoroom/ui/quoroom.icns"
  fi
  ICON_DST="${APP_RESOURCES}/quoroom-server.icns"

  mkdir -p "${APP_MACOS}" "${APP_RESOURCES}"

  # Copy the pre-compiled tray binary into the .app bundle.
  TRAY_SRC="/usr/local/lib/quoroom/ui/QuoroomTray"
  if [ ! -f "${TRAY_SRC}" ] && [ -f "${HOME}/usr/local/lib/quoroom/ui/QuoroomTray" ]; then
    TRAY_SRC="${HOME}/usr/local/lib/quoroom/ui/QuoroomTray"
  fi
  if [ -f "${TRAY_SRC}" ]; then
    cp -f "${TRAY_SRC}" "${APP_EXEC}"
  else
    # Fallback: minimal bash launcher (same health-check pattern).
    cat > "${APP_EXEC}" << 'APP'
#!/bin/bash
PORT="${QUOROOM_PORT:-3700}"
URL="http://localhost:${PORT}"
BIN_PATH="/usr/local/lib/quoroom/bin/quoroom"
if [ ! -x "${BIN_PATH}" ] && [ -x "${HOME}/usr/local/lib/quoroom/bin/quoroom" ]; then
  BIN_PATH="${HOME}/usr/local/lib/quoroom/bin/quoroom"
fi
LOG_DIR="${HOME}/Library/Logs/Quoroom"
LOG_FILE="${LOG_DIR}/server.log"
mkdir -p "${LOG_DIR}"
is_quoroom_healthy() {
  CODE="$(curl -sS -m 1 -o /dev/null -w "%{http_code}" "${URL}/api/auth/handshake" 2>/dev/null || true)"
  [ "${CODE}" = "200" ]
}
if is_quoroom_healthy; then open "${URL}"; exit 0; fi
QUOROOM_NO_AUTO_OPEN=1 nohup "${BIN_PATH}" serve --port "${PORT}" >> "${LOG_FILE}" 2>&1 &
for _ in 1 2 3 4 5 6 7 8 9 10; do
  if is_quoroom_healthy; then break; fi
  sleep 1
done
open "${URL}"
APP
  fi
  chmod 755 "${APP_EXEC}"

  if [ -f "${ICON_SRC_SERVER}" ]; then
    cp -f "${ICON_SRC_SERVER}" "${ICON_DST}"
  elif [ -f "${ICON_SRC_DEFAULT}" ]; then
    cp -f "${ICON_SRC_DEFAULT}" "${ICON_DST}"
  fi

  cat > "${APP_CONTENTS}/Info.plist" << 'PLIST'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>CFBundleDisplayName</key>
    <string>Quoroom Server</string>
    <key>CFBundleExecutable</key>
    <string>QuoroomServerLauncher</string>
    <key>CFBundleIdentifier</key>
    <string>ai.quoroom.server-launcher</string>
    <key>CFBundleName</key>
    <string>Quoroom Server</string>
    <key>CFBundleIconFile</key>
    <string>quoroom-server.icns</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0</string>
    <key>LSMinimumSystemVersion</key>
    <string>11.0</string>
    <key>LSUIElement</key>
    <true/>
  </dict>
</plist>
PLIST
}

LAUNCHER_APPS_DIR="/Applications"
if [ ! -w "${LAUNCHER_APPS_DIR}" ]; then
  if [ -n "${CONSOLE_USER}" ] && [ "${CONSOLE_USER}" != "root" ]; then
    LAUNCHER_APPS_DIR="/Users/${CONSOLE_USER}/Applications"
  else
    LAUNCHER_APPS_DIR="${HOME}/Applications"
  fi
fi
mkdir -p "${LAUNCHER_APPS_DIR}" 2>/dev/null || true
create_launcher_app "${LAUNCHER_APPS_DIR}"
if [ -n "${CONSOLE_USER}" ] && [ "${CONSOLE_USER}" != "root" ]; then
  chown -R "${CONSOLE_USER}" "${LAUNCHER_APPS_DIR}/Quoroom Server.app" 2>/dev/null || true
fi

# Installers run as root; detect the active desktop user.
if [ -z "${CONSOLE_USER}" ] || [ "${CONSOLE_USER}" = "root" ]; then
  exit 0
fi
if [ -z "${CONSOLE_UID}" ]; then
  exit 0
fi

LOG_DIR="/Users/${CONSOLE_USER}/Library/Logs/Quoroom"
LOG_FILE="${LOG_DIR}/server.log"
mkdir -p "${LOG_DIR}"
chown "${CONSOLE_USER}" "${LOG_DIR}" 2>/dev/null || true

# Clean stale auto-update directory — full installer supersedes user-space updates.
# The server also does this check on startup, but cleaning here ensures the
# wrapper script uses the fresh bundled code immediately.
USER_APP_DIR="/Users/${CONSOLE_USER}/.quoroom/app"
if [ -d "${USER_APP_DIR}" ]; then
  rm -rf "${USER_APP_DIR}"
fi

# Kill any old quoroom server — the binaries were just overwritten so the old
# process is running stale code and would die soon anyway.
OLD_PIDS="$(lsof -nP -iTCP:"${PORT}" -sTCP:LISTEN -t 2>/dev/null || true)"
if [ -n "${OLD_PIDS}" ]; then
  kill ${OLD_PIDS} 2>/dev/null || true
  sleep 1
  kill -9 ${OLD_PIDS} 2>/dev/null || true
fi

# Launch the tray app — it handles server start, health check, and browser open.
APP_TO_LAUNCH="${LAUNCHER_APPS_DIR}/Quoroom Server.app"
launchctl asuser "${CONSOLE_UID}" sudo -u "${CONSOLE_USER}" open "${APP_TO_LAUNCH}" 2>/dev/null \
  || sudo -u "${CONSOLE_USER}" open "${APP_TO_LAUNCH}" 2>/dev/null \
  || true

exit 0
