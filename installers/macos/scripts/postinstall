#!/bin/bash

# Create symlink so 'quoroom' is on PATH.
BIN_PATH="/usr/local/lib/quoroom/bin/quoroom"
ln -sf "${BIN_PATH}" /usr/local/bin/quoroom

PORT="${QUOROOM_PORT:-3700}"
URL="http://localhost:${PORT}"

create_launcher_app() {
  # Remove legacy launcher name to avoid duplicate Dock entries after upgrade.
  rm -rf "/Applications/Quoroom.app"

  APP_PATH="/Applications/Quoroom Server.app"
  APP_CONTENTS="${APP_PATH}/Contents"
  APP_MACOS="${APP_CONTENTS}/MacOS"
  APP_RESOURCES="${APP_CONTENTS}/Resources"
  APP_EXEC="${APP_MACOS}/QuoroomServerLauncher"
  ICON_SRC_SERVER="/usr/local/lib/quoroom/ui/quoroom-server.icns"
  ICON_SRC_DEFAULT="/usr/local/lib/quoroom/ui/quoroom.icns"
  ICON_DST="${APP_RESOURCES}/quoroom-server.icns"

  mkdir -p "${APP_MACOS}" "${APP_RESOURCES}"

  cat > "${APP_EXEC}" << 'APP'
#!/bin/bash
PORT="${QUOROOM_PORT:-3700}"
URL="http://localhost:${PORT}"
BIN_PATH="/usr/local/lib/quoroom/bin/quoroom"
LOG_DIR="${HOME}/Library/Logs/Quoroom"
LOG_FILE="${LOG_DIR}/server.log"

mkdir -p "${LOG_DIR}"

if lsof -nP -iTCP:"${PORT}" -sTCP:LISTEN -t >/dev/null 2>&1; then
  open "${URL}"
  exit 0
fi

nohup "${BIN_PATH}" serve --port "${PORT}" >> "${LOG_FILE}" 2>&1 &
sleep 1
open "${URL}"
APP
  chmod 755 "${APP_EXEC}"

  if [ -f "${ICON_SRC_SERVER}" ]; then
    cp -f "${ICON_SRC_SERVER}" "${ICON_DST}"
  elif [ -f "${ICON_SRC_DEFAULT}" ]; then
    cp -f "${ICON_SRC_DEFAULT}" "${ICON_DST}"
  fi

  cat > "${APP_CONTENTS}/Info.plist" << 'PLIST'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>CFBundleDisplayName</key>
    <string>Quoroom Server</string>
    <key>CFBundleExecutable</key>
    <string>QuoroomServerLauncher</string>
    <key>CFBundleIdentifier</key>
    <string>ai.quoroom.server-launcher</string>
    <key>CFBundleName</key>
    <string>Quoroom Server</string>
    <key>CFBundleIconFile</key>
    <string>quoroom-server.icns</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0</string>
    <key>LSMinimumSystemVersion</key>
    <string>11.0</string>
  </dict>
</plist>
PLIST
}

create_launcher_app

# Installers run as root; detect the active desktop user.
CONSOLE_USER="$(stat -f%Su /dev/console 2>/dev/null || true)"
if [ -z "${CONSOLE_USER}" ] || [ "${CONSOLE_USER}" = "root" ]; then
  exit 0
fi
CONSOLE_UID="$(id -u "${CONSOLE_USER}" 2>/dev/null || true)"
if [ -z "${CONSOLE_UID}" ]; then
  exit 0
fi

LOG_DIR="/Users/${CONSOLE_USER}/Library/Logs/Quoroom"
LOG_FILE="${LOG_DIR}/server.log"
mkdir -p "${LOG_DIR}"
chown "${CONSOLE_USER}" "${LOG_DIR}" 2>/dev/null || true

# Clean stale auto-update directory — full installer supersedes user-space updates.
# The server also does this check on startup, but cleaning here ensures the
# wrapper script uses the fresh bundled code immediately.
USER_APP_DIR="/Users/${CONSOLE_USER}/.quoroom/app"
if [ -d "${USER_APP_DIR}" ]; then
  rm -rf "${USER_APP_DIR}"
fi

# Kill any old quoroom server — the binaries were just overwritten so the old
# process is running stale code and would die soon anyway.
OLD_PIDS="$(lsof -nP -iTCP:"${PORT}" -sTCP:LISTEN -t 2>/dev/null || true)"
if [ -n "${OLD_PIDS}" ]; then
  kill ${OLD_PIDS} 2>/dev/null || true
  sleep 1
  kill -9 ${OLD_PIDS} 2>/dev/null || true
fi

# Start fresh server.
START_CMD="nohup \"${BIN_PATH}\" serve --port ${PORT} >> \"${LOG_FILE}\" 2>&1 &"
launchctl asuser "${CONSOLE_UID}" sudo -u "${CONSOLE_USER}" /bin/bash -lc "${START_CMD}" 2>/dev/null \
  || sudo -u "${CONSOLE_USER}" /bin/bash -lc "${START_CMD}" 2>/dev/null \
  || true

# Open dashboard in the logged-in user's browser.
launchctl asuser "${CONSOLE_UID}" sudo -u "${CONSOLE_USER}" open "${URL}" 2>/dev/null \
  || sudo -u "${CONSOLE_USER}" open "${URL}" 2>/dev/null \
  || true

exit 0
